# å°†å½“å‰ä»“åº“ï¼ˆmasterï¼‰åŒæ­¥åˆ° GitHub ä»“åº“
# ä½¿ç”¨æ–¹å¼ï¼šåœ¨ AONE ä¸­åˆ›å»ºæµæ°´çº¿å¹¶é€‰æ‹©æ­¤æ–‡ä»¶ï¼Œè§¦å‘æ–¹å¼é€‰æ‹©ã€Œæ‰‹åŠ¨è§¦å‘ã€
name: "Sync Repo to GitHub"

params:
  github_repo:
    name: GitHub ä»“åº“
    type: string
    default: "agentbay-ai/agentbay-skills"
    description: "ç›®æ ‡ GitHub ä»“åº“ (æ ¼å¼: username/repo-name)"

  source_branch:
    name: æºåˆ†æ”¯
    type: string
    default: "master"
    description: "è¦åŒæ­¥çš„ GitLab åˆ†æ”¯"

  target_branch:
    name: ç›®æ ‡åˆ†æ”¯
    type: string
    default: "main"
    description: "GitHub ä¸Šçš„ç›®æ ‡åˆ†æ”¯"

  runs_on_resources:
    name: èµ„æºè§„æ ¼
    description: "è¿è¡Œå®¹å™¨èµ„æºè§„æ ¼"
    default: "2-8Gi"
    options:
      - "2-8Gi"
      - "4-16Gi"
      - "8-32Gi"

jobs:
  sync-to-github:
    continue-on-error: false
    name: "Sync to GitHub"
    # åœ¨ AONE ä¸­å°†æ­¤ Job è®¾ç½®ä¸ºã€Œä»…æ‰‹åŠ¨è§¦å‘ã€å³å¯å®ç°æ‰‹åŠ¨æ‰§è¡Œ
    runs-on:
      - "${{params.runs_on_resources}}"
    image: alios-8u
    timeout: 15m

    steps:
      - uses: checkout
        inputs:
          fetch-depth: 0
          ref: "${{params.source_branch}}"
          username: "wuying-ai-team"
          token: ${{secrets.wuying_ai_team_private_token}}

      - id: validate-github-config
        name: "Validate GitHub Configuration"
        run: |
          echo "ğŸ”§ Validating GitHub configuration..."

          if [ -z "${{secrets.agbaccount_github_token}}" ]; then
            echo "âŒ agbaccount_github_token æœªåœ¨ GitLab CI/CD å˜é‡ä¸­é…ç½®"
            echo "è¯·åœ¨ GitLab Settings â†’ CI/CD â†’ Variables ä¸­æ·»åŠ  agbaccount_github_token (Masked)"
            echo "æ‰€éœ€æƒé™: repo, workflow"
            exit 1
          fi

          if [ -z "${{vars.agbaccount_github_username}}" ]; then
            echo "âŒ agbaccount_github_username æœªé…ç½®"
            exit 1
          fi

          if [ -z "${{vars.agbaccount_github_email}}" ]; then
            echo "âŒ agbaccount_github_email æœªé…ç½®"
            exit 1
          fi

          GITHUB_REPO="${{params.github_repo}}"
          if [ -z "$GITHUB_REPO" ]; then
            echo "âŒ æœªæŒ‡å®š github_repo å‚æ•°"
            exit 1
          fi

          if [[ ! "$GITHUB_REPO" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo "âŒ éæ³•ä»“åº“æ ¼å¼: $GITHUB_REPOï¼Œåº”ä¸º username/repo-name"
            exit 1
          fi

          echo "ğŸ” Testing GitHub token..."
          TOKEN_HTTP=$(curl -s -w "%{http_code}" -H "Authorization: token ${{secrets.agbaccount_github_token}}" \
            "https://api.github.com/user" -o /dev/null)
          if [ "$TOKEN_HTTP" != "200" ]; then
            echo "âŒ GitHub Token æ ¡éªŒå¤±è´¥ (HTTP $TOKEN_HTTP)"
            exit 1
          fi

          echo "ğŸ” Testing repository access..."
          REPO_HTTP=$(curl -s -w "%{http_code}" -H "Authorization: token ${{secrets.agbaccount_github_token}}" \
            "https://api.github.com/repos/${GITHUB_REPO}" -o /dev/null)
          if [ "$REPO_HTTP" != "200" ]; then
            echo "âŒ æ— æ³•è®¿é—®ä»“åº“ ${GITHUB_REPO} (HTTP $REPO_HTTP)"
            exit 1
          fi

          echo "âœ… GitHub é…ç½®æ ¡éªŒé€šè¿‡"
          echo "  - ä»“åº“: $GITHUB_REPO"
          echo "  - æºåˆ†æ”¯: ${{params.source_branch}} â†’ ç›®æ ‡åˆ†æ”¯: ${{params.target_branch}}"
          echo "GITHUB_REPO=$GITHUB_REPO" >> $AONE_CI_ENV

      - id: exclude-aone
        name: "Exclude .aone for GitHub"
        run: |
          set -e
          # åŸºäºå½“å‰æ£€å‡ºçš„æºåˆ†æ”¯åˆ›å»ºåŒæ­¥ç”¨ä¸´æ—¶åˆ†æ”¯ï¼ˆä¸ä¿®æ”¹æºåˆ†æ”¯ï¼‰
          git checkout -B sync-to-github

          # ä»å³å°†æ¨é€çš„æäº¤ä¸­ç§»é™¤ .aoneï¼ˆä»…å†…éƒ¨ä»“åº“ä½¿ç”¨çš„ CI é…ç½®ï¼‰
          if [ -d ".aone" ]; then
            git rm -r --cached .aone 2>/dev/null || true
            if ! git diff --cached --quiet; then
              git commit -m "chore: exclude .aone from GitHub (internal CI only)"
              echo "âœ… .aone å·²ä»æ¨é€å†…å®¹ä¸­æ’é™¤"
            else
              echo "âœ… .aone å·²ä¸åœ¨ç´¢å¼•ä¸­ï¼Œæ— éœ€æäº¤"
            fi
          else
            echo "âœ… ä»“åº“ä¸­æ—  .aone ç›®å½•"
          fi

      - id: push-to-github
        name: "Push to GitHub"
        run: |
          set -e
          GITHUB_REPO="${{params.github_repo}}"
          TARGET_BRANCH="${{params.target_branch}}"
          GITHUB_USERNAME="${{vars.agbaccount_github_username}}"
          GITHUB_EMAIL="${{vars.agbaccount_github_email}}"

          echo "ğŸš€ Syncing to https://github.com/${GITHUB_REPO} (${TARGET_BRANCH})"

          git config --global user.name "$GITHUB_USERNAME"
          git config --global user.email "$GITHUB_EMAIL"
          git config --global init.defaultBranch "$TARGET_BRANCH"

          # ä½¿ç”¨ Token è®¤è¯çš„ remote URL
          GITHUB_URL="https://${GITHUB_USERNAME}:${{secrets.agbaccount_github_token}}@github.com/${GITHUB_REPO}.git"

          if git remote get-url github > /dev/null 2>&1; then
            git remote set-url github "$GITHUB_URL"
          else
            git remote add github "$GITHUB_URL"
          fi

          # æ¨é€ sync-to-githubï¼ˆå·²æ’é™¤ .aoneï¼‰åˆ° GitHub main
          echo "â¬†ï¸ Pushing to github/${TARGET_BRANCH} (excluding .aone)..."
          if git push github "sync-to-github:${TARGET_BRANCH}" --force --no-verify; then
            echo "âœ… å·²åŒæ­¥åˆ° GitHub"
            echo "ğŸ”— https://github.com/${GITHUB_REPO}/tree/${TARGET_BRANCH}"
          else
            echo "âŒ æ¨é€å¤±è´¥"
            exit 1
          fi

      - id: report
        name: "Report"
        run: |
          echo "=================================="
          echo "ğŸ“Š Sync Report"
          echo "=================================="
          echo "âœ… Status: SUCCESS"
          echo "ğŸ“… $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“‚ Repo: ${{params.github_repo}}"
          echo "ğŸŒ¿ ${{params.source_branch}} â†’ ${{params.target_branch}}"
          echo "ğŸ”— https://github.com/${{params.github_repo}}"
          echo "=================================="
